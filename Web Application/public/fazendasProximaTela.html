<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/fazendaProximaTela.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <!-- Menu Lateral -->
    <section class="menu-lateral">
        <div class="identificacao-empresa">
            <h1>Empresa</h1>
        </div>

        <div>
            <b>
                <p>Menu</p>
            </b>
            <a href="dashboard.html"><button class="btn-dashboard"><img src="./assets/Chart.png" alt="dashboard icon"
                        class="dashboard icon"> Dashboard</button></a>
            <a href="fazendas.html"><button class="btn-fazenda"> <img src="./assets/Vector.png" alt="fazenda icon"
                        class="icon">Fazendas</button></a>
            <a href="equipe.html"><button class="btn-equipe"><img src="./assets/Group.png" alt="equipe icon"
                        class="icon"> Equipe</button></a>
            <a href="recomendacoes.html"><button class="btn-recomendacoes"><img src="./assets/Chat.png"
                        alt="recomendacoes icon" class="icon"> Recomendações</button></a>

            <b>
                <p>Outros</p>
            </b>
            <a href="conta.html"><button class="btn-conta"><img src="./assets/Profile.png" alt="conta icon"
                        class="icon"> Conta</button></a>
            <a href="suporte.html"><button class="btn-suporte"> <img src="./assets/Info Square.png" alt="suporte icon"
                        class="icon">Suporte</button></a>
            <a href="login.html"><button onclick="limparSessao()" class="btn-sair"><img
                        src="./assets/icons8-exit-50.png" alt="exit icon" class="icon"> Sair</button></a>
        </div>
    </section>

    <div class="container">
        <!-- Navbar no topo -->
        <div class="navbar">
            <img src="./assets/Group 376.png" alt="perfil icon" class="icon">
            <h3 id="b_usuario">Cliente</h3>
        </div>

        <!-- Conteúdo principal -->
        <div class="container-group">
            <div class="gerenciar-fazenda">
                <div class="card-cargos" id="card-equipe">
                    <div class="info-card">
                        <h1>Equipe</h1>
                        <span>Acesse os membros cadastrados na equipe dessa fazenda.</span>
                    </div>
                    <div>
                        <img class="img-fundo" src="./assets/imgs/image 15.png" alt="">
                    </div>
                </div>
                <div class="card-equipe" id="card-cargos" onclick="irParaTelaCargos()">
                    <div class="info-card">
                        <h1>Cargo</h1>
                        Acesse os membros cadastrados na equipe dessa fazenda.
                    </div>
                    <div class="image-title">
                        <img class="img-equipe" src="./assets/imgs/image 17.png" alt="">
                    </div>
                </div>
                <img src="./assets/imgs/Ellipse 14.png" alt="" class="image-elipse">
            </div>

            <div class="editar-fazenda">
                <div class="modal-fazenda" id="modal-fazenda">
                    <div class="content-modal">
                        <div class="group-titles"></div>

                        <div class="group-fields">
                            <span class="label">Nome Fazenda:</span>
                            <input disabled type="text" id="input_nome_fazenda_edit">
                        </div>
                        <div class="group-fields">
                            <span class="label">Tipo Café:</span>
                            <select disabled name="" id="select_tipo_cafe_edit">
                                <option value="#">-</option>
                            </select>
                        </div>
                        <div class="group-fields">
                            <span class="label">Estado da Fazenda:</span>
                            <select disabled name="" id="select_estado_fazenda_edit">
                                <option value="#">-</option>
                            </select>
                        </div>
                        <div class="group-fields">
                            <span class="label">Município da Fazenda:</span>
                            <select disabled name="" id="select_municipio_fazenda_edit">
                                <option value="#">-</option>
                            </select>
                        </div>
                        <div class="group-buttons">
                            <button class="button-editar" id="button-editar">Editar</button>
                            <button class="button-remover" onclick="removerFazenda()">Remover</button>
                        </div>
                        <span id="message"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>


<script>

    let listaEstadoMunicipio = [];
    listarEstados();
    function listarEstados() {
        fetch("/fazenda/listarEstados", {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((fazenda) => {
                    const estadosUnicos = new Set();

                    fazenda.forEach((fazendaEstado) => {
                        estadosUnicos.add(fazendaEstado.estado);
                    });

                    estadosUnicos.forEach((estadosUnico) => {
                        const estado = fazenda.find(item => item.estado == estadosUnico);
                        select_estado_fazenda_edit.innerHTML += `<option value='${estado.idUf}'>${estado.estado}</option>`;


                    });

                    fazenda.forEach((fazendaEstado) => {
                        select_municipio_fazenda_edit.innerHTML += `<option value='${fazendaEstado.idMunicipio}'>${fazendaEstado.municipio}</option>`;
                    });

                    listaEstadoMunicipio = fazenda;
                    console.log('Lista de Estados e Municípios:\n', listaEstadoMunicipio);

                    select_estado_fazenda_edit.value = sessionStorage.ESTADO_FAZENDA;
                    select_municipio_fazenda_edit.value = sessionStorage.MUNICIPIO_FAZENDA;
                    input_nome_fazenda_edit.value = sessionStorage.NOME_FAZENDA;



                });

            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }


    select_estado_fazenda_edit.addEventListener('change', function (e) {
        const estadoSelecionado = e.target.value;
        const select_municipio = document.getElementById('select_municipio_fazenda_edit');

        select_municipio.innerHTML = "<option value='#'>Selecione o município</option>";

        if (estadoSelecionado !== "#") {
            select_municipio.disabled = false;
            const municipiosFiltrados = listaEstadoMunicipio.filter(item => item.idUf == estadoSelecionado);


            municipiosFiltrados.forEach(item => {
                select_municipio.innerHTML += `<option value='${item.idMunicipio}'>${item.municipio}</option>`;
            });
        } else {

            select_municipio.innerHTML = "<option value='#'>Selecione o município</option>";
        }
    });

    document.getElementById('button-editar').addEventListener('click', function () {
        select_estado_fazenda_edit.disabled = false;
        select_municipio_fazenda_edit.disabled = false;
        select_tipo_cafe_edit.disabled = false;
        input_nome_fazenda_edit.disabled = false;

        const button = document.getElementById('button-editar');
        button.textContent = 'Enviar';

        button.addEventListener('click', function () {
            editarFazenda();
        });
    });

    function habilitarMensagem(mensagem) {
        const p = document.getElementById('message');
        p.style.display = "block"
        p.innerHTML = mensagem;
    }

    function ocultarMensagem() {
        const p = document.getElementById('message');
        p.style.display = "none";
    }

    function removerFazenda() {

        const idFazenda = sessionStorage.ID_FAZENDA;

        fetch('fazenda/removerFazenda', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idFazenda: idFazenda
            }),
        })
            .then(function (resposta) {
                return resposta.json().then(data => {
                    console.log("Resposta do servidor: ", data);

                    if (!resposta.ok) {
                        throw new Error(data.erro);
                    }
                    else {
                        habilitarMensagem(data.message);

                        setTimeout(() => {
                            window.location = "fazendas.html";
                        }, 2000);
                    }
                });
            })
            .catch(function (erro) {
                console.log(`#ERRO: ${erro}`);
                habilitarMensagem(erro.message);
            });

        return false;
    }

    const equipe = document.getElementById('card-equipe');
    equipe.addEventListener('click', function () {
        window.location = "equipe.html";
    });

    function editarFazenda() {
        const nomeFazenda = document.getElementById('input_nome_fazenda_edit').value;
        const tipoCafe = document.getElementById('select_tipo_cafe_edit').value;
        const estadoFazenda = sessionStorage.ID_ESTADO;
        const idFazenda = sessionStorage.ID_FAZENDA;
        const idEstado = select_estado_fazenda_edit.value;
        const idMunicipio = select_municipio_fazenda_edit.value;

        const estadoMunicipio = buscarIdPorEstadoMunicipio(idEstado, idMunicipio);

        if (!estadoMunicipio) {
            return false;
        }

        fetch('fazenda/editarFazenda', {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idFazenda: idFazenda,
                tipoCafe: tipoCafe,
                estadoMunicipio: estadoMunicipio,
                nomeFazenda: nomeFazenda
            }),
        })
            .then(function (resposta) {
                return resposta.json().then(data => {
                    console.log("Resposta do servidor: ", data);

                    if (!resposta.ok) {
                        throw new Error(data.erro);
                    }
                    else {
                        habilitarMensagem(data.message);
                        // listarEstados();
                        bloquearCampos();
                        sessionStorage.setItem('TIPO_CAFE_FAZENDA', tipoCafe);
                        sessionStorage.setItem('ESTADO_FAZENDA', idEstado);
                        sessionStorage.setItem('MUNICIPIO_FAZENDA', idMunicipio);
                        sessionStorage.setItem('NOME_FAZENDA', nomeFazenda);

                    }
                    setTimeout(() => {
                        ocultarMensagem();
                    }, 2000)
                });

            })
            .catch(function (erro) {
                console.log(`#ERRO: ${erro}`);
            }).finally(() => {
                select_tipo_cafe_edit.value = sessionStorage.TIPO_CAFE_FAZENDA;
                select_estado_fazenda_edit.value = sessionStorage.ESTADO_FAZENDA;
                select_municipio_fazenda_edit.value = sessionStorage.MUNICIPIO_FAZENDA;
                input_nome_fazenda_edit.value = sessionStorage.NOME_FAZENDA;
            });

        return false;
    }
    function buscarIdPorEstadoMunicipio(estado, municipio) {
        const resultado = listaEstadoMunicipio.find(item =>
            item.idUf == estado && item.idMunicipio == municipio
        );

        if (resultado) {
            console.log("ID encontrado:", resultado.id);
            return resultado.id;
        } else {
            console.log("Estado e município não encontrados.");
            return null;
        }
    }

    function bloquearCampos() {
        const nomeFazenda = document.getElementById('input_nome_fazenda_edit');
        const tipoCafe = document.getElementById('select_tipo_cafe_edit');
        const estadoFazenda = document.getElementById('select_estado_fazenda_edit');
        const municipioFazenda = document.getElementById('select_municipio_fazenda_edit');

        nomeFazenda.disabled = true;
        tipoCafe.disabled = true;
        estadoFazenda.disabled = true;
        municipioFazenda.disabled = true;

        const buttonEditar = document.getElementById("button-editar");
        buttonEditar.innerHTML = "Editar";
    }

    listarTipoCafe();
    function listarTipoCafe() {
        fetch("/fazenda/listarTipoCafe", {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((fazenda) => {
                    fazenda.forEach((fazendaTipoCafe) => {
                        select_tipo_cafe_edit.innerHTML += `<option value='${fazendaTipoCafe.id}'>${fazendaTipoCafe.nome}</option>`
                    });
                    select_tipo_cafe_edit.value = sessionStorage.TIPO_CAFE_FAZENDA;
                });

            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function irParaTelaCargos() {
       document.getElementById("card-cargos").addEventListener('click', function() {
            window.location = "cargos.html";
       })
    }

</script>