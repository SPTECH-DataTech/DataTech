<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/logo_datatech_-_roxa_escuro.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/dashboard2.css">

    <title>Dashboard • DataTech </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


</head>

<body>

    <section class="menu-lateral">
        <div class="identificacao-empresa">
            <h1 id="name_empresa"></h1>
        </div>

        <div>
            <b>
                <p>Menu</p>
            </b>
            <a href="dashboard.html"><button class="btn-dashboard"><img src="./assets/Chart.png" alt="dashboard icon"
                        class="icon"> Dashboard</button></a>
            <a href="fazendas.html"><button class="btn-fazenda"> <img src="./assets/Vector.png" alt="fazenda icon"
                        class="icon">Fazendas</button></a>
            <!-- <a href="equipe.html"><button class="btn-equipe"><img src="./assets/Group.png" alt="equipe icon"
                        class="icon">
                    Equipe</button></a>
            <a href="recomendacoes.html"><button class="btn-recomendacoes"><img src="./assets/Chat.png"
                        alt="recomendacoes icon" class="icon"> Recomendações</button></a> -->

            <b>
                <p>Outros</p>
            </b>
            <a href="dashConta.html"><button class="btn-conta"><img src="./assets/Profile.png" alt="conta icon"
                        class="icon">
                    Conta</button></a>
            <a href="suporte.html"><button class="btn-suporte"> <img src="./assets/Info Square.png" alt="suporte icon"
                        class="icon">Suporte</button></a>
            <a href="login.html"><button onclick="limparSessao()" class="btn-sair"><img
                        src="./assets/icons8-exit-50.png" alt="exit icon" class="icon"> Sair</button></a>
        </div>

    </section>

    <section class="main-section">
        <div class="navbar">
            <img src="./assets/Group 376.png" alt="perfil icon" class="icon">
            <h3 id="b_usuario"></h3>
        </div>

        <!-- -------------------------GRAFICO 1------------------------- -->
        <section class="dashboard">

            <div class="titulo-dash">
                <h2>Café Arábica x Café Robusta</h2>
                <a href="./dashboard.html"><button class="btn-proxima-tela">Voltar</button></a>
            </div>


            <div class="grafico-kpi">
                <div class="graficoProducao">
                    <div class="titulo-grafico">
                        <h1>Comparação Café Arábica x Café Robusta das Fazendas por Estado</h1>
                    </div>

                    <div class="escolher-info">
                        <div class="container">
                            <select id="select-ano">
                            </select>
                            <button class="btn-atualizar" onclick="atualizaSelects()">Atualizar</button>
                        </div>
                    </div>

                    <canvas id="graficoCafe"></canvas>

                </div>
                <div class="kpis">
                    <div class="kpi" id="kpiCafeMaisEficiente">
                        <div class="titulo-kpi">
                            <h4 style="color: #10BB00;">Tipo de Café com maior eficiência</h2>
                        </div>
                        <div class="infos-kpi">
                            <p>Café <span id="tipoCafeMaisProduzido">Arábica</span></p>
                            <p><span id="relacaoEspeculacaoColhido">0 / 0 (t)</span></p>
                        </div>
                        <div class="percentagem">
                            <h3 style="color: #10BB00;" id="percentualProducao">0.0% de Produção</h3>
                        </div>
                    </div>

                    <div class="kpi">
                        <div class="titulo-kpi">
                            <h4 style="color: #ff0000;">Tipo de Café com menor eficiência</h2>
                        </div>
                        <div class="infos-kpi">
                            <p>Café <span id="tipoCafeMenosProduzido">Robusta</span></p>
                            <p><span id="relacaoEspeculacaoColhido2">0 / 0 (t)</span></p>
                        </div>
                        <div class="percentagem">
                            <h3 style="color: #ff0000;" id="percentualProducao2">0.0% de Produção</h3>
                        </div>
                    </div>
                </div>

            </div>

            <div class="container-Regioes-Indicador">

                <div class="containerTopRegioes">
                    <h2 style="color: #5400BB;">Top 5 Regiões Produção</h2>
                    <table id="topCinco">
                        <!-- <tr> 
                            <td class="colunaTabela">
                                <span id="">Estado1</span>
                            </td>
                            <td class="colunaTabela coluna2">
                                <span id="">70% Produção</span>
                            </td>
                            <td class="colunaTabela coluna3">
                                <span id="">676.750(t)</span>
                            </td>
                        </tr> -->
                    </table>
                </div>

                <br>
                <div class="containerIndicadorSaca">

                    <div class="titulo-kpi">
                        <h2 class="tituloIndicadorSaca">Valores das Safras</h2>
                        <p>Valor total da Safra dos Cafés (<span id="anoSafra">2017</span>)</p>
                    </div>

                    <table id="tabelaSaca">
                        <!-- <tr>
                            <th>Março/17</th>
                            <th class="coluna2">Reais</th>
                        </tr> -->

                        <!-- <tr>
                            <td class="colunaTabela">
                                <img src="./assets/imgs/cafe-icon.jpg" alt="Café Arábica" class="icon-cafe">
                                <p class="nomeCafeIndicador">Arábica</p>
                            </td>
                            <td class="coluna2">R$ 2.090,65</td>
                        </tr> -->

                        <!-- <tr>
                            <td class="colunaTabela">
                                <img src="./assets/imgs/cafe-icon.jpg" alt="Café Arábica" class="icon-cafe">
                                <p class="nomeCafeIndicador">Robusta</p>
                            </td>
                            <td class="coluna2">R$ 1.766,75</td>
                        </tr> -->

                    </table>

                </div>

            </div>

        </section>

    </section>
    <script src="./js/dashProximaTela.js"></script>
    <script src="./js/dashProximaTela.js"></script>
    <script src="./js/sessao.js"></script>

</body>

<script>
    const idEmpresa = sessionStorage.getItem('ID_EMPRESA');
    window.onload = consultarAnos();


    function consultarAnos() {
        console.log("idempresa: " + idEmpresa);
        fetch(`/dash2/consultarAnos/${idEmpresa}`).then(function (resposta) {
            console.log(resposta)
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    for (let i = 0; i < resposta.length; i++) {

                        let ano = resposta[i].ano;

                        const select = document.getElementById("select-ano");

                        const opcao = document.createElement('option');
                        opcao.value = ano;
                        opcao.textContent = ano;
                        select.appendChild(opcao);

                    }

                    atualizaSelects();

                });
                if (resposta.length > 0) {
                    selectAno.value = dados[0].ano;

                    atualizaSelects();


                }
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function atualizaSelects() {
        const ano = document.getElementById("select-ano").value;
        console.log("Atualiza atualiza atualiza" + ano);
        obterCafeMaisEficiente(ano);
        obterCafeMenosEficiente(ano);
        obterTop5(ano);
        obterValorSafra(ano);
        listarComparacaoProducaoCafe(ano);

    }



    function obterCafeMaisEficiente(ano) {
        fetch(`/dash2/obterCafeMaisEficiente/${idEmpresa}/${ano}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    for (let i = 0; i < resposta.length; i++) {
                        const dados = resposta[i];

                        document.getElementById("tipoCafeMaisProduzido").textContent =
                            dados.nomeCafe;
                        document.getElementById("relacaoEspeculacaoColhido").textContent = dados.especulacaoToneladasPlantadas + " / " + dados.toneladasColhidas + " (t)";
                        document.getElementById("percentualProducao").textContent = dados.percentualEfeciencia + "% de Produção";

                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }

    function obterCafeMenosEficiente(ano) {
        fetch(`/dash2/obterCafeMenosEficiente/${idEmpresa}/${ano}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    for (let i = 0; i < resposta.length; i++) {
                        const dados = resposta[i];
                        console.log("AAAAA " + dados.percentualEfeciencia)

                        document.getElementById("tipoCafeMenosProduzido").textContent = dados.nomeCafe;
                        document.getElementById("relacaoEspeculacaoColhido2").textContent = dados.especulacaoToneladasPlantadas + " / " + dados.toneladasColhidas + " (t)";
                        document.getElementById("percentualProducao2").textContent = dados.percentualEfeciencia + "% de Produção";


                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }

    function obterTop5(ano) {
        console.log("idempresa: " + idEmpresa);
        fetch(`/dash2/obterTop5/${idEmpresa}/${ano}`).then(function (resposta) {
            console.log(resposta)
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    const tabela = document.getElementById("topCinco");
                    tabela.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {

                        let estado = resposta[i].estado;
                        let percentualEfeciencia = resposta[i].percentualEfeciencia;
                        let totalColhido = resposta[i].totalColhido;
                        
                        tabela.innerHTML += `
                        <tr>
                            <td class="colunaTabela">
                                ${estado}
                            </td>
                            <td class="colunaTabela coluna2">
                                ${percentualEfeciencia}% Produção
                            </td>
                            <td class="colunaTabela coluna3">
                                ${totalColhido}(t)
                            </td>
                        </tr>
                        `;
                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function obterValorSafra(ano) {
        tabelaSaca.innerHTML = `<tr>
                            <th>Março/17</th>
                            <th class="coluna2">Reais</th>
                        </tr>`
        fetch(`/dash2/totalSafra/${ano}/${idEmpresa}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    for (let i = 0; i < resposta.length; i++) {
                        const dados = resposta[i];
                        const numeroFormatado = new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL',
                        }).format(dados.totalSafra);

                        tabelaSaca.innerHTML += `
                        <tr>
                            <td class="colunaTabela">
                                <img src="./assets/imgs/cafe-icon.jpg" alt="Café Arábica" class="icon-cafe">
                                <p class="nomeCafeIndicador">${dados.nomeCafe}</p>
                            </td>
                            <td class="coluna2">${numeroFormatado}</td>
                        </tr>
                        `;
                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    const ctx = document.getElementById('graficoCafe').getContext('2d');
    const graficoCafe = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [], // Estados
            datasets: [
                {
                    label: 'Café Arábica',
                    data: [], // Dados de toneladas de café plantado por estado
                    backgroundColor: '#46351e', // Cor para o plantio
                    borderWidth: 1,
                    barThickness: 20 // Define a espessura da barra (ajuste conforme necessário)
                },
                {
                    label: 'Café Robusta',
                    data: [], // Dados de toneladas de café colhido por estado
                    backgroundColor: '#E0D5BA', // Cor para a colheita
                    borderWidth: 1,
                    barThickness: 20 // Define a espessura da barra (ajuste conforme necessário)
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true, // Inicia o eixo Y em 0
                    title: {
                        display: true,
                        text: 'Toneladas'
                    }
                },
                x: {
                    stacked: false, // Configura para não empilhar as barras
                    categoryPercentage: 100, // Ajuste para controlar o espaço das categorias
                    barPercentage: 0.5 // Ajuste para controlar o espaço das barras
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Produção de Café por Estado (Toneladas)'
                }
            }
        }
    });

    function listarComparacaoProducaoCafe(ano) {
        fetch(`/dash2/listarComparacaoProducaoCafe/${idEmpresa}/${ano}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    graficoCafe.data.datasets[0].data = [];
                    graficoCafe.data.datasets[1].data = [];
                    graficoCafe.data.labels = [];
                    
                        resposta.forEach((estado) => {

                        console.log(estado.nomeEstado)
                        graficoCafe.data.labels.push(estado.nomeEstado);

                        graficoCafe.data.datasets[0].data.push(estado.arabica);

                        graficoCafe.data.datasets[1].data.push(estado.robusta);

                        graficoCafe.update();

                    })
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

</script>

</html>