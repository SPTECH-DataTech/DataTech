<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    #container {
        display: none;
    }
</style>

<body onload="verificarToken()">
    <div id="container" class="container">
        <h1>Informe a nova senha:</h1>
        Senha:
        <input type="text" id="input_senha">
        <br>
        Confirmar Senha:
        <input type="text" id="input_confirmacaoSenha">
        <br>
        <button onclick="redefinirSenha()">Redefinir</button>
    </div>
</body>

</html>


<script>
    function getToken() {
        const parametroUrl = new URLSearchParams(window.location.search); // Objeto que contém a parte da URL após o ?
        return parametroUrl.get('token');
    }

    function verificarToken() {
        const token = getToken();

        const payload = JSON.parse(atob(token.split('.')[1])); // Acessa a carga útil do token
        const horaAtual = new Date().getTime() / 1000; 

        if (horaAtual > payload.exp) {
            alert("Token expirado. Solicite a redefinição de senha novamente!");
            window.location.href = "./recuperarSenha.html";
        } else {
            document.getElementById('container').style.display = "block";
        }
    }

    function redefinirSenha() {
        const senha = input_senha.value;
        const confirmarSenha = input_confirmacaoSenha.value;
        const token = getToken();

        if (senha != confirmarSenha) {
            alert("Senha inválidas!");
            return;
        }

        fetch('/recuperarSenha/atualizarSenha', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                senha: senha,
                token: token
            }),
        })
            .then(function (resposta) {

                if (resposta.ok) {
                    console.log("Resposta do servidor: ", resposta);

                    alert("A senha foi redefinida com sucesso!");

                    setTimeout(() => {
                        window.location = "./login.html";
                    }, 2000);
                }
                else {
                    // console.log("Houve um erro ao redefinir a senha");
                    // resposta.text().then(texto => {
                    //     console.error(texto);
                    //     alert(texto);
                    // });
                    throw "Houve um erro ao redefinir a senha";
                }
            })
            .catch(function (erro) {
                console.log(`#ERRO: ${erro}`);
                alert(erro);
            });

    }
</script>