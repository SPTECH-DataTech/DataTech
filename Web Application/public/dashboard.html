<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/logo_datatech_-_roxa_escuro.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/dashboard.css">

    <title>Dashboard • DataTech </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>

    <section class="menu-lateral">
        <div class="identificacao-empresa">
            <h1 id="name_empresa"></h1>
        </div>

        <div>
            <b>
                <p>Menu</p>
            </b>
            <a href="dashboard.html"><button class="btn-dashboard"><img src="./assets/Chart.png" alt="dashboard icon"
                        class="dashboard icon"> Dashboard</button></a>
            <a href="fazendas.html"><button class="btn-fazenda"> <img src="./assets/Vector.png" alt="fazenda icon"
                        class="icon">Fazendas</button></a>
            <!-- <a href="equipe.html"><button class="btn-equipe"><img src="./assets/Group.png" alt="equipe icon" class="icon">
                    Equipe</button></a>
            <a href="recomendacoes.html"><button class="btn-recomendacoes"><img src="./assets/Chat.png"
                        alt="recomendacoes icon" class="icon"> Recomendações</button></a> -->

            <b>
                <p>Outros</p>
            </b>
            <a href="dashConta.html"><button class="btn-conta"><img src="./assets/Profile.png" alt="conta icon"
                        class="icon">
                    Conta</button></a>
            <a href="suporte.html"><button class="btn-suporte"> <img src="./assets/Info Square.png" alt="suporte icon"
                        class="icon">Suporte</button></a>
            <a href="login.html"><button onclick="limparSessao()" class="btn-sair"><img
                        src="./assets/icons8-exit-50.png" alt="exit icon" class="icon"> Sair</button></a>
        </div>

    </section>

    <section class="main-section">
        <div class="navbar">
            <img src="./assets/Group 376.png" alt="perfil icon" class="icon">
            <h3 id="b_usuario"></h3>
        </div>

        <!-- -------------------------GRAFICO 1------------------------- -->
        <section class="dashboard">

            <div class="titulo-dash">
                <h2>Análise da Produção de Café e Relação com as Condições Climáticas</h2>
                <a href="./dashProximaTela.html"><button class="btn-proxima-tela">Próxima tela</button></a>
            </div>


            <div class="grafico-1">
                <div class="titulo-grafico">
                    <h1>Plantio e Colheita de Café</h1>
                </div>

                <div class="escolher-info">
                    <div class="container">
                        <form id="filtroForm">
                            <select id="select-ano" class="select-ano">
                            </select>

                            <select id="select-cafe" class="select-cafe">
                                <option value="1">Café Arábica</option>
                                <option value="2">Café Robusta</option>
                            </select>

                            <button type="button" class="btn-atualizar" id="btn-atualizar" onclick="atualizaSelects()">Atualizar</button>

                        </form>
                    </div>


                    <div class="grafico-plantacao">
                        <canvas id="graficoCafe"></canvas>

                        <div class="kpis">
                            <div class="kpi">
                                <div class="titulo-kpi">
                                    <h2 style="color: #10BB00;">Maior eficiência de Produção</h2>
                                </div>
                                <div class="infos-kpi">
                                    <h3 id="estado_maior_eficiencia"></h3>
                                    <h3 id="quantidade_perdida_plantada_maior"></h3>
                                </div>
                                <div class="percentagem">
                                    <h4 style="color: #10BB00; font-size: 20px;"
                                        id="maior_eficiencia_porcentagem_perdida"></h4>
                                </div>
                            </div>

                            <div class="kpi">
                                <div class="titulo-kpi">
                                    <h2 style="color: #ff0000;"> Menor eficiência de Produção</h2>
                                </div>
                                <div class="infos-kpi">
                                    <h3 id="estado_menor_eficiencia"></h3>
                                    <h3 id="quantidade_perdida_plantada_menor"></h3>
                                </div>
                                <div class="percentagem">
                                    <h4 style="color: #ff0000; font-size: 20px;"
                                        id="menor_eficiencia_porcentagem_perdida"></h4>
                                </div>
                            </div>
                        </div>

                    </div>


                </div>



                <div class="grafico-1">
                    <div class="titulo-grafico2">
                        <h1>Climograma por Estado</h1>
                    </div>

                    <div class="container">
                        <select class="select-ano2">
                            <option value="1985">1985</option>
                            <option value="1995">1995</option>
                            <option value="2006">2006</option>
                            <option value="2016">2016</option>
                        </select>

                        <select class="select-estado">
                            <option value=""></option>
                            <option value="">Acre</option>
                            <option value="">Alagoas</option>
                            <option value="">Amazonas</option>
                            <option value="">Bahia</option>
                            <option value="">Ceará</option>
                            <option value="">Distrito Federal</option>
                            <option value="">Espírito Santo</option>
                            <option value="">Goiás</option>
                            <option value="">Maranhão</option>
                            <option value="">Mato Grosso</option>
                            <option value="">Mato Grosso do Sul</option>
                            <option value="">Minas Gerais</option>
                            <option value="">Pará</option>
                            <option value="">Paraíba</option>
                            <option value="">Paraná</option>
                            <option value="">Pernambuco</option>
                            <option value="">Piauí</option>
                            <option value="">Rio de Janeiro</option>
                            <option value="">Rio Grande do Norte</option>
                            <option value="">Rio Grande do Sul</option>
                            <option value="">Rondônia</option>
                            <option value="">Roraima</option>
                            <option value="">Santa Catarina</option>
                            <option value="">São Paulo</option>
                            <option value="">Sergipe</option>
                            <option value="">Tocantins</option>
                        </select>


                        <button type="submit" class="btn-atualizar">Atualizar</button>
                    </div>





                    <div class="grafico-plantacao">
                        <canvas id="climograma"></canvas>

                        <div class="kpis">
                            <div class="kpi2">
                                <div class="titulo-kpi">
                                    <center>
                                        <h3 style="color: #ff0000;">Meses Inadequados Produção</h2>
                                    </center>
                                </div>

                                <div class="infos-kpi2">
                                    <h3 style="color: black;"> Mês </h3>
                                    <h3 style="color: black;"> Umid. </h3>
                                    <h3 style="color: black;"> Temp. </h3>
                                </div>

                                <div class="infos-kpi2">
                                    <h3> Junho </h3>
                                    <h3> 60% </h3>
                                    <h3> 30ºC </h3>
                                </div>

                                <div class="infos-kpi2">
                                    <h3> Julho </h3>
                                    <h3> 55% </h3>
                                    <h3> 31ºC </h3>
                                </div>


                            </div>
                        </div>

                    </div>


                </div>
        </section>

    </section>
    <script src="./js/dashboard.js"></script>
</body>

<script>

function carregarAnos() {
    fetch('/dashboard/listarAnos')
        .then((resposta) => resposta.json())
        .then((dados) => {
            const selectAno = document.getElementById('select-ano');
            dados.forEach((ano) => {
                const opcao = document.createElement('option');
                opcao.value = ano.ano;
                opcao.textContent = ano.ano; 
                selectAno.appendChild(opcao);
            });
            if (dados.length > 0) {
                selectAno.value = dados[0].ano;
                const tipoCafe = document.getElementById("select-cafe").value;
                atualizaSelects(); 
            }
        })
        .catch((erro) => {
            console.error('Erro ao carregar os anos:', erro);
        });
}

function carregarTiposCafe() {
    const selectCafe = document.getElementById("select-cafe");
    if (selectCafe.options.length > 0) {
        selectCafe.value = selectCafe.options[0].value;
    }
}

window.onload = function() {
    carregarAnos();
    carregarTiposCafe();
    atualizarDashboard();
};

function atualizaSelects() {
    const ano = document.getElementById("select-ano").value;
    const tipoCafe = document.getElementById("select-cafe").value;

    if (ano !== "#" && tipoCafe !== "#") {
        carregarGrafico(ano, tipoCafe);
        carregarMaiorEficiencia(ano, tipoCafe);
        carregarMenorEficiencia(ano, tipoCafe);
    } else {
        alert("Por favor, selecione um ano e tipo de café válidos.");
    }
}



let chartInstance; 

function criarGrafico(estados, cafePlantado, cafeColhido) {
    const ctx = document.getElementById("graficoCafe").getContext("2d");

    // Verifica se há um gráfico existente e o destrói
    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: estados,
            datasets: [
                {
                    label: "Café Plantado (Toneladas)",
                    data: cafePlantado,
                    backgroundColor: '#a56aec',
                    borderWidth: 1,
                    barThickness: 20
                },
                {
                    label: "Café Colhido (Toneladas)",
                    data: cafeColhido,
                    backgroundColor: '#6c81dd',
                    borderWidth: 1,
                    barThickness: 20
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: "top"
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Toneladas"
                    }
                },
                x: {
                    stacked: false,
                    categoryPercentage: 100,
                    barPercentage: 0.5
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Produção de Café por Estado (Toneladas)'
                }
            }
        }
    });
}


function carregarGrafico(ano, tipoCafe) {
    fetch("/dashboard/listarProducaoCafe", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            anoServer: ano,
            tipoCafeServer: tipoCafe
        })
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Erro ao buscar dados.");
            }
        })
        .then(data => {
            console.log("Dados recebidos:", data);
            if (data.length > 0) {
                const estados = data.map(item => item.estado);
                const cafePlantado = data.map(item => parseFloat(item.toneladasPlantadas));
                const cafeColhido = data.map(item => parseFloat(item.toneladasColhidas));

                console.log(estados, cafePlantado, cafeColhido);
                criarGrafico(estados, cafePlantado, cafeColhido);
            } else {
                alert("Não há dados para o ano e tipo de café selecionados.");
            }
        })
        .catch(error => {
            console.error("Erro:", error);
            alert("Erro ao buscar os dados da produção de café. O banco de dados não possui esse dado! Ano: " + ano + " ou o tipo de café: " + tipoCafe);
        });
}

function carregarMaiorEficiencia(ano, tipoCafe) {
    fetch("/dashboard/obterMaiorEficiencia", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            anoServer: ano,
            tipoCafeServer: tipoCafe
        })
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Erro ao buscar dados.");
            }
        })
        .then(data => {
            document.getElementById("estado_maior_eficiencia").textContent = data.estado;
            document.getElementById("quantidade_perdida_plantada_maior").textContent = data.quantidadePerdida + " / " + data.quantidadePlantada + " (t)";
            document.getElementById("maior_eficiencia_porcentagem_perdida").textContent = data.porcentagemPerda + "%";
        })
        .catch(error => {
            console.error("Erro:", error);
            alert("Erro ao buscar os dados da maior eficiência. O banco de dados não possui esse dado! Ano: " + ano + " ou o tipo de café: " + tipoCafe);
        });
}

function carregarMenorEficiencia(ano, tipoCafe) {
    fetch("/dashboard/obterMenorEficiencia", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            anoServer: ano,
            tipoCafeServer: tipoCafe
        })
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Erro ao buscar dados.");
            }
        })
        .then(data => {
            document.getElementById("estado_menor_eficiencia").textContent = data.estadoMenor;
            document.getElementById("quantidade_perdida_plantada_menor").textContent = data.quantidadePerdidaMenor + " / " + data.quantidadePlantadaMenor + " (t)";
            document.getElementById("menor_eficiencia_porcentagem_perdida").textContent = data.porcentagemPerdaMenor + "%";
        })
        .catch(error => {
            console.error("Erro:", error);
            alert("Erro ao buscar os dados da menor eficiência. O banco de dados não possui esse dado! Ano: " + ano + " ou o tipo de café: " + tipoCafe);
        });
}

</script>
<script>
    const ctx1 = document.getElementById('climograma').getContext('2d');
    const climograma = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [
                {
                    label: 'Temperatura Média (°C)',
                    data: [22, 23, 24, 26, 28, 30, 31, 30, 28, 25, 23, 21],
                    type: 'line',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y temperature'
                },
                {
                    label: 'Umidade (%)',
                    data: [85, 80, 75, 70, 65, 60, 55, 60, 70, 75, 80, 85],
                    backgroundColor: '#6c81dd',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y moisture',
                    barThickness: 20
                },

            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                },
                'y moisture': {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Umidade (%)'
                    }
                },
                'y temperature': {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Temperatura Média (°C)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Climograma: Temperatura e Umidade'
                }
            }
        }
    });
</script>

</html>